# Sample ROP attack

This sample code simulates a Return Oriented Programming (ROP) attack.

A function named `function_with_stack_overflow()` is supposed to have a bug.
It overflows a local buffer on stack, smashing the callers stack frames,
typically when some invalid input is received. In this program, we directly
overflow the local buffer in the source code.

The effect of this attack is to take control of the system: a shell command
is run and the application terminates. In this example, the shellcode only
displays a message but it could do any nasty thing...

Note: In the real world, a ROP attack is designed for a given version of a binary.
This example was tested on Linux with gcc. The code which is generated by clang is
different and would need another form of malicious payload.

The Makefile builds two versions of the program, an unprotected one with the
default options, and a protected one using Pointer Authentication Code (PAC).
The assembly code is also produced.

The two versions are exactly identical, except the generation of PACIASP
and AUTIASP in the protected version.

~~~
$ diff rop-attack-unprotected.s rop-attack-protected.s
19a20,21
>       hint    25 // paciasp
>       .cfi_window_save
96a99,100
>       hint    29 // autiasp
>       .cfi_window_save
106a111,112
>       hint    25 // paciasp
>       .cfi_window_save
120a127,128
>       hint    29 // autiasp
>       .cfi_window_save
130a139,140
>       hint    25 // paciasp
>       .cfi_window_save
162a173,174
>       hint    29 // autiasp
>       .cfi_window_save
168a181,190
>       .section        .note.gnu.property,"a"
>       .align  3
>       .word   4
>       .word   16
>       .word   5
>       .string "GNU"
>       .word   3221225472
>       .word   4
>       .word   2
>       .align  3
~~~

When running the unprotected version, the shellcode is injected and executed:

~~~
$ ./rop-attack-unprotected
in function_with_stack_overflow()
=== shellcode running, you are hacked ===
Terminated
~~~

With the protected version, the pointer authentication makes the program
crash when the shellcode is about to be executed:

~~~
$ ./rop-attack-protected
in function_with_stack_overflow()
Segmentation fault (core dumped)
~~~
